<html>
  <head>
    <script src="http://192.168.1.5:8090/socket.io/socket.io.js"></script>
  </head>
  <body>
    <script>
      var socket = io.connect('http://192.168.1.5:8090');
      var connected = false;
      var selectedTabId = null;

      socket.on('connect', function() {
        connected = true;
      });

      socket.on('newUrl', function(data) {
        if (localStorage['mode'] === 'server') {
          chrome.tabs.create({'url': data.url});
        }
      });

      chrome.tabs.onActiveChanged.addListener(function(tabId, selectInfo) {
        selectedTabId = tabId;
      });

      chrome.extension.onRequest.addListener(
        function(request, sender, sendResponse) {
          if (connected && selectedTabId && request.action === 'sendTab') {
            chrome.tabs.get(selectedTabId, function(tab) {
              if (tab) {
                socket.emit('newUrl', {'url': tab.url});
                sendResponse({'message': 'sent: ' + tab.url});
              } else {
                sendResponse({'message': 'tab undefined'});
              }
            });
          }
      });
    </script>
  </body>
