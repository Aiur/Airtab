<html>
  <head>
    <script src="jquery.js"></script>
  </head>
  <body>
    <script>
      var state = {
        connected: false,
        selectedTabId: null,
        postUrl: null,
      };

      chrome.tabs.onActiveChanged.addListener(function(tabId, selectInfo) {
        state.selectedTabId = tabId;
      });
      
      function sendTab(sendReturn) {
          if (state.selectedTabId) {
            chrome.tabs.get(state.selectedTabId, function(tab) {
              if (tab) {
                $.post(state.postUrl, {'url': tab.url,
                  success: function () {
                    sendReturn('YAY');
                    console.log('yay!');
                  },
                  error: function(xhr, ajaxOptions, thrownError) {
                    sendReturn('Hopefully sent the URL');
                  }}); 
              } else {
                console.log('tab undefined');
                sendReturn('tab undefined, booo!');
              }
            });
          } else {
            console.log('invalid tab or invalid action');
            sendReturn('invalid tab or no tab');
          }
      }

      // Listen for the 'sendTab' action from the popup. 
      chrome.extension.onRequest.addListener(
        function(request, sender, sendResponse) {
          if (state.selectedTabId && request.action === "sendTab") {
            chrome.tabs.get(state.selectedTabId, function(tab) {
              if (tab) {
                $.post(state.postUrl, {'url': tab.url})
                  .success(function () {
                    sendResponse({"message": "sent: " + tab.url});
                  })
                  .error(function() {
                    sendResponse({"message": "ajax post failed."});
                  }); 
              } else {
                sendResponse({"message": "tab undefined"});
              }
            });
          } else {
            sendResponse({"message": "invalid tab or invalid action"});
          }
      });

      function reload() {
        state = {
          connected: false,
          selectedTabId: null,
          postUrl: null,
        };

        state.postUrl = [
          "http://", localStorage["host"], ":", localStorage["port"], "/newUrl"
        ].join("");
      }

      reload();
    </script>
  </body>
